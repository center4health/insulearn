<!DOCTYPE html>
<html lang="en">

<head>
  <title>Diabetes Educational Tool</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<!-- https://stackoverflow.com/questions/42720488/d3-v4-drag-line-chart-with-x-and-y-axes -->
<!-- Thanks to Mark - https://stackoverflow.com/users/16363/mark -->
<style>
  .popup {
    display: none;
    background-color: white;
    position: absolute;
    top: 320px;
    z-index: 0.5;
    width: 25%;
    left: 37%;
    border-style: solid;
    border-width: 10px;
    border-top: hidden;
    border-right: hidden;
    border-left: hidden;
    -webkit-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -moz-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -o-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    border-radius: 5px;
    padding: 20px;
  }

  .example-open .modal-backdrop {
    background-color: black;
    /* adds overlay to beginning pop-up */
  }

  .modal-backdrop {
    background-color: transparent;
    /* removes overlay from popup */
  }

  .modal-content {
    /* shadow for the modal */
    -webkit-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -moz-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -o-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    border: white 0px;
  }

  #target {
    position: absolute;
    width: 300px;
    top: 615px;
    left: 765px;
    z-index: 10;
    border-bottom: hidden;
  }

  #intro,
  #scenario {
    position: absolute;
    top: 25%
  }

  /* #reset {
      position: absolute;
      top: 250px;
      right: 350px;
    } */

  .tooltip-inner {
    background-color: white;
    font-family: 'Montserrat', sans-serif;
    color: black;
    font-size: 16px;
    padding: 20px;
    -webkit-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -moz-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    -o-box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    box-shadow: 2px 2px 10px 0px rgba(209, 209, 209, 1);
    border: white 0px;
    max-width: 300px;
    text-align: left;
  }

  .tooltip.in {
    opacity: 1;
    /* solid background for tooltip */
  }

  #timeNum {
    font-size: 24px;
    color: #41948E;
  }

  #bolus_meal_time {
    font-size: 12px;
    margin-top: -15px;
    margin-bottom: -5px;
    padding-left: 125px;
    margin-left: -100px;
    margin-right: -100px;
  }
</style>

<body>

  <!--Fixed Navigation Bar-->
  <nav class="navbar navbar-default navbar-fixed-top" id="header">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
          data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><b>InsuLearn</b></a>
      </div>

      <!-- Links to home, interactive graphs, terminology, and about -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="index.html">Home</a></li>
          <li class="active"><a href="#">Interactive Graphs</a></li>
          <li><a href="terminology.html">Learn More</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>

  <div class="container">
    <a href="graphs-menu.html" style="color: #9B9B9B"><img src="img/back_arrow.png" style="width: 25px"> Back to
      Interactive Graphs Menu</a>
    <center>
      <div style="width: 750px">
        <h3 style="text-align: left"><b>Insulin Timing & Dosing</b></h3>
        <p style="text-align: left">Choose a starting graph</p>
      
       
        <svg width="750" height="525"></svg>
      


        <div class="row">
          <!-- TIME SLIDER-->
          <div class="col-sm-2">
            <p id="selectedTime">Time (hr): 5:00 PM</p>
          </div>
          <div class="col-sm-10">
            <p id="bolus_meal_time">15 min after meal</p>
            <input type="range" name="bolus_time" id=bolus_time min="-150" max="100" value="0"
              style="width: 600px"></input>
          </div>
        </div>
        <div class="row">
          <!-- DOSING SLIDER-->
          <div class="col-sm-2">
            <p style="padding-top: 10px">Dose (U)</p>
          </div>
          <div class="col-sm-10">
            <input type="range" name="insulin_amt" id=insulin_amt min="0" max="100" value="0"
              style="width: 600px"></input>
          </div>
        </div>
        <div class="row">
          <!-- Meal SLIDER-->
          <div class="col-sm-2">
            <p style="padding-top: 10px">Meal time</p>
          </div>
          <div class="col-sm-10">
            <input type="range" name="meal_time" id=meal_time min="-150" max="100" value="0"
              style="width: 600px"></input>
          </div>
        </div>
      </div>
    </center>
  </div>



</body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="dwn.js"></script>
<script>
  "use strict";
  //let's get our data ready
  let show = 0;
  let selectVal = 0;
 
  let bg_raw = [["12:02:52", 104.0], ["12:07:52", 104.0], ["12:12:51", 103.0],
  ["12:17:52", 103.0], ["12:22:51", 103.0], ["12:27:51", 103.0],
  ["12:32:51", 101.0], ["12:37:52", 100.0], ["12:42:51", 101.0],
  ["12:47:52", 101.0], ["12:52:51", 102.0], ["12:57:51", 102.0],
  ["13:02:50", 102.0], ["13:07:50", 102.0], ["13:12:51", 101.0],
  ["13:17:51", 100.0], ["13:22:51", 100.0], ["13:27:51", 101.0],
  ["13:32:51", 100.0], ["13:37:51", 100.0], ["13:42:51", 101.0],
  ["13:47:50", 101.0], ["13:52:50", 100.0], ["13:57:52", 98.0],
  ["14:02:51", 100.0], ["14:07:51", 101.0], ["14:12:51", 99.0],
  ["14:17:51", 91.0], ["14:22:52", 90.0], ["14:27:51", 95.0],
  ["14:32:52", 94.0], ["14:37:51", 93.0], ["14:42:51", 96.0],
  ["14:47:51", 95.0], ["14:52:51", 96.0], ["14:57:52", 97.0],
  ["15:02:51", 97.0], ["15:07:50", 97.0], ["15:12:50", 97.0],
  ["15:17:50", 94.0], ["15:22:50", 92.0], ["15:27:50", 93.0],
  ["15:32:51", 94.0], ["15:37:51", 93.0], ["15:42:50", 92.0],
  ["15:47:50", 91.0], ["15:52:50", 90.0], ["15:57:50", 89.0],
  ["16:02:50", 90.0], ["16:07:51", 92.0], ["16:12:49", 95.0],
  ["16:17:50", 98.0], ["16:22:50", 101.0], ["16:27:50", 102.0],
  ["16:32:49", 106.0], ["16:37:50", 109.0], ["16:42:51", 111.0],
  ["16:47:51", 114.0], ["16:52:50", 114.0], ["16:57:51", 115.0],
  ["17:02:50", 118.0], ["17:07:50", 117.0], ["17:12:50", 118.0],
  ["17:17:50", 128.0], ["17:22:51", 132.0], ["17:27:50", 133.0],
  ["17:32:50", 133.0], ["17:37:50", 136.0], ["17:42:50", 140.0],
  ["17:47:50", 141.0], ["17:52:51", 144.0], ["17:57:51", 151.0],
  ["18:02:50", 156.0], ["18:07:50", 164.0], ["18:12:50", 168.0],
  ["18:17:51", 173.0], ["18:22:51", 181.0], ["18:27:51", 188.0],
  ["18:32:51", 198.0], ["18:37:51", 205.0], ["18:42:51", 209.0],
  ["18:47:50", 212.0], ["18:52:50", 210.0], ["18:57:51", 213.0],
  ["19:02:50", 216.0], ["19:07:51", 222.0], ["19:12:50", 222.0],
  ["19:17:51", 224.0], ["19:22:51", 223.0], ["19:27:51", 229.0],
  ["19:32:51", 230.0], ["19:37:50", 226.0], ["19:42:49", 223.0],
  ["19:47:50", 229.0], ["19:52:50", 225.0], ["19:57:50", 230.0],
  ["20:02:49", 235.0], ["20:07:50", 235.0], ["20:12:50", 235.0],
  ["20:17:49", 238.0], ["20:22:50", 240.0], ["20:27:50", 248.0],
  ["20:32:49", 257.0], ["20:37:49", 259.0], ["20:42:50", 260.0],
  ["20:47:50", 269.0], ["20:52:49", 269.0], ["20:57:50", 269.0],
  ["21:02:50", 267.0], ["21:07:50", 274.0], ["21:12:50", 275.0],
  ["21:17:50", 272.0], ["21:22:50", 273.0], ["21:27:50", 275.0],
  ["21:32:50", 288.0], ["21:37:50", 278.0], ["21:42:50", 280.0],
  ["21:47:50", 284.0], ["21:52:49", 281.0], ["21:57:50", 282.0],
  ["22:02:50", 280.0], ["22:07:50", 278.0], ["22:12:50", 279.0],
  ["22:17:49", 277.0], ["22:22:50", 274.0], ["22:27:50", 279.0],
  ["22:32:50", 276.0], ["22:37:50", 281.0], ["22:42:50", 281.0],
  ["22:47:50", 278.0], ["22:52:49", 276.0], ["22:57:50", 274.0],
  ["23:02:50", 281.0], ["23:07:50", 277.0], ["23:12:50", 277.0],
  ["23:17:50", 276.0], ["23:22:50", 280.0], ["23:27:50", 286.0],
  ["23:32:50", 285.0], ["23:37:50", 283.0], ["23:42:50", 288.0],
  ["23:47:50", 284.0], ["23:52:50", 280.0], ["23:57:50", 289.0]];
  
  let bg=new Glucose()
  bg.loadJSON(bg_raw)

  let timeParse = d3.timeParse("%H:%M:%S")

  let insulin_bolus=new Insulin(10, timeParse("17:00:00"), INSULIN_TYPE.RAPID);

  bg.addFactor(insulin_bolus);


  let meal=new Meal(10, timeParse("16:42:00"))
  bg.addFactor(meal);
  
  let chart=new Chart("svg", bg.getTimeRange())

  insulin_bolus.draw(chart.getCanvas());

  meal.draw(chart.getCanvas());

  
  bg.draw(chart.getCanvas());





  

  


  


  function selected_time(bolus_time) {
    var hours = bolus_time.getHours(); // gives the value in 24 hours format
    var AmOrPm = hours >= 12 ? 'PM' : 'AM';
    hours = (hours % 12) || 12;
    var minutes = bolus_time.getMinutes() > 9 ? bolus_time.getMinutes() : '0' + bolus_time.getMinutes();
    var finalTime = "Time (hr): " + hours + ":" + minutes + " " + AmOrPm;
    document.getElementById("selectedTime").innerHTML = finalTime;
  }

  function time_from_meal(bolus_time) {
    var bt_min = (bolus_time.getHours() * 60) + bolus_time.getMinutes();
    var mt_min = 16 * 60 + 45;
    var difference = bt_min - mt_min;
    if (difference > 0) {
      if (difference > 60) {
        var hour = Math.floor(difference / 60)
        var min = difference % 60
        if (min == 0) { document.getElementById("bolus_meal_time").innerHTML = (hour) + " hr after meal"; }
        else { document.getElementById("bolus_meal_time").innerHTML = hour + "hr " + min + " min after meal"; }
      }
      else {
        document.getElementById("bolus_meal_time").innerHTML = difference + " min after meal";
      }
    }
    else if (difference <= 0) {
      if (difference < -60) {
        var hour = Math.abs(Math.floor(difference / -60))
        var min = Math.abs(difference % 60)
        if (min == 0) { document.getElementById("bolus_meal_time").innerHTML = (hour) + " hr before meal"; }
        else { document.getElementById("bolus_meal_time").innerHTML = hour + "hr " + min + " min before meal"; }
      }
      else {
        document.getElementById("bolus_meal_time").innerHTML = Math.abs(difference) + " min before meal";
      }
    }
    let pos = (difference * 4.5) + 50;
    if (pos >= 0) {
      document.getElementById("bolus_meal_time").style.paddingLeft = pos + "px";
    }
    if (pos < 0) {
      document.getElementById("bolus_meal_time").style.paddingRight = Math.abs(pos) + "px";
    }
  }


  

  d3.select("#meal_time").on("input", function (d) {
    let selectedValue = parseInt(this.value, 10);
    meal.changeTimeByMinute(selectedValue)
    meal.refresh()
    bg.refresh()
   
  });

  d3.select("#bolus_time").on("input", function (d) {
    let selectedValue = parseInt(this.value, 10);
    insulin_bolus.changeTimeByMinute(selectedValue)
    let insulin = insulin_bolus.getShape()
    let bolus_time = insulin_bolus.getTime()

    selected_time(bolus_time) // update selected time in the html
    time_from_meal(bolus_time)
    
    insulin_bolus.refresh()
    bg.refresh()

  });

  d3.select("#insulin_amt").on("input", function (d) {
    let dose = parseInt(this.value, 10)
    var insulin=insulin_bolus.setDose(dose);
    insulin_bolus.refresh()
    bg.refresh()
  });

  // function to add shadow to the navbar
  $(window).scroll(function () {
    var scroll = $(window).scrollTop();
    if (scroll > 0) {
      $("#header").addClass("active");
    }
    else {
      $("#header").removeClass("active");
    }
  });

  // tooltips
  $(function () { $('[data-toggle="tooltip"]').tooltip() })

  $('#back').on('click', function () { window.location = 'graphs-menu.html'; });
  $('#reset').on('click', function () { window.location = 'prebolus.html'; });
  $('#next').on('click', function () { $('#intro').modal('hide'); });
</script>

</html>