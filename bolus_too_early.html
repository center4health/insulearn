<!DOCTYPE html>
<html lang="en">
<body>

<div class="container">
    <center>
        <svg width="750" height="525"></svg> <!-- changed the size of the graph -->
    </center>
</div>

</body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    //let's get our data ready

    let bg_raw = [["12:02:52", 104.0], ["12:07:52", 104.0], ["12:12:51", 103.0],
        ["12:17:52", 100.0], ["12:22:51", 100.0], ["12:27:51", 102.0],
        ["12:32:51", 103.0], ["12:37:52", 104.0], ["12:42:51", 106.0],
        ["12:47:52", 107.0], ["12:52:51", 108.0], ["12:57:51", 109.0],
        ["13:02:50", 110.0], ["13:07:50", 113.0], ["13:12:51", 114.0],
        ["13:17:51", 114.0], ["13:22:51", 114.0], ["13:27:51", 116.0],
        ["13:32:51", 117.0], ["13:37:51", 118.0], ["13:42:51", 118.0],
        ["13:47:50", 118.0], ["13:52:50", 119.0], ["13:57:52", 120.0],
        ["14:02:51", 120.0], ["14:07:51", 121.0], ["14:12:51", 123.0],
        ["14:17:51", 123.0], ["14:22:52", 123.0], ["14:27:51", 125.0],
        ["14:32:52", 124.0], ["14:37:51", 124.0], ["14:42:51", 124.0],
        ["14:47:51", 124.0], ["14:52:51", 124.0], ["14:57:52", 124.0],
        ["15:02:51", 124.0], ["15:07:50", 124.0], ["15:12:50", 124.0],
        ["15:17:50", 124.0], ["15:22:50", 124.0], ["15:27:50", 124.0],
        ["15:32:51", 124.0], ["15:37:51", 124.0], ["15:42:50", 124.0],
        ["15:47:50", 120.0], ["15:52:50", 115.0], ["15:57:50", 110.0],
        ["16:02:50", 105.0], ["16:07:51", 100.0], ["16:12:49", 95.0],
        ["16:17:50", 90.0], ["16:22:50", 85.0], ["16:27:50", 85.0],
        ["16:32:49", 83.0], ["16:37:50", 81.0], ["16:42:51", 77.0],
        ["16:47:51", 74.0], ["16:52:50", 72.0], ["16:57:51", 70.0],
        ["17:02:50", 70.0], ["17:07:50", 69.0], ["17:12:50", 69.0],
        ["17:17:50", 69.0], ["17:22:51", 72.0], ["17:27:50", 74.0],
        ["17:32:50", 77.0], ["17:37:50", 81.0], ["17:42:50", 86.0],
        ["17:47:50", 89.0], ["17:52:51", 93.0], ["17:57:51", 99.0],
        ["18:02:50", 100.0], ["18:07:50", 120.0], ["18:12:50", 130.0],
        ["18:17:51", 145.0], ["18:22:51", 147.0], ["18:27:51", 155.0],
        ["18:32:51", 160.0], ["18:37:51", 160.0], ["18:42:51", 165.0],
        ["18:47:50", 170.0], ["18:52:50", 180.0], ["18:57:51", 190.0],
        ["19:02:50", 190.0], ["19:07:51", 200.0], ["19:12:50", 200.0],
        ["19:17:51", 210.0], ["19:22:51", 210.0], ["19:27:51", 210.0],
        ["19:32:51", 210.0], ["19:37:50", 213.0], ["19:42:49", 225.0],
        ["19:47:50", 230.0], ["19:52:50", 234.0], ["19:57:50", 246.0],
        ["20:02:49", 248.0], ["20:07:50", 250.0], ["20:12:50", 255.0],
        ["20:17:49", 257.0], ["20:22:50", 260.0], ["20:27:50", 262.0],
        ["20:32:49", 264.0], ["20:37:49", 266.0], ["20:42:50", 268.0],
        ["20:47:50", 270.0], ["20:52:49", 272.0], ["20:57:50", 274.0],
        ["21:02:50", 277.0], ["21:07:50", 279.0], ["21:12:50", 280.0],
        ["21:17:50", 282.0], ["21:22:50", 284.0], ["21:27:50", 283.0],
        ["21:32:50", 284.0], ["21:37:50", 283.0], ["21:42:50", 283.0],
        ["21:47:50", 283.0], ["21:52:49", 283.0], ["21:57:50", 283.0],
        ["22:02:50", 283.0], ["22:07:50", 283.0], ["22:12:50", 283.0],
        ["22:17:49", 283.0], ["22:22:50", 283.0], ["22:27:50", 283.0],
        ["22:32:50", 283.0], ["22:37:50", 283.0], ["22:42:50", 283.0],
        ["22:47:50", 283.0], ["22:52:49", 283.0], ["22:57:50", 283.0],
        ["23:02:50", 283.0], ["23:07:50", 283.0], ["23:12:50", 283.0],
        ["23:17:50", 283.0], ["23:22:50", 283.0], ["23:27:50", 283.0],
        ["23:32:50", 283.0], ["23:37:50", 283.0], ["23:42:50", 283.0],
        ["23:47:50", 283.0], ["23:52:50", 283.0], ["23:57:50", 283.0]];
    let insulin = [[0, 0], [30, 30], [60, 80], [90, 95], [120, 100], [150, 90], [180, 50], [210, 35], [240, 20], [270, 15], [300, 10], [330, 5], [360, 0]]


    var timeParse = d3.timeParse("%H:%M:%S")
    bg_raw.forEach(d => {
        d[0] = timeParse(d[0]);
    })


    default_bolus_time = timeParse("17:00:00");
    offset = 0;
    var dose = 1;

    function calculate_insulin_curve(bolus = default_bolus_time) {
        var curve = [];
        insulin.forEach(d => {

            curve.push([d3.timeMinute.offset(bolus, d[0]), dose*d[1]])
        })
        return curve
    }
    insulin_curve = calculate_insulin_curve();

    //console.log(insulin_curve)

    var svg = d3.select("svg"),
        margin = { top: 20, right: 20, bottom: 30, left: 50 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;


    function apply_insulin(insulin){
        //ugly way of copying an array
        var bg = bg_raw.map(function(arr) {
            return arr.slice();
        });

        k=0
        for (i = 0; i < bg.length; i++){

            if (bg[i][0]>insulin[0][0]){
                var old_change=bg_raw[i][1]-bg_raw[i-1][1];

                bg[i][1]=bg[i-1][1]+old_change

                if (Math.floor(k/6)<insulin.length){
                    bg[i][1]-=insulin[Math.floor(k/6)][1]/20;
                }
                k+=1
            }
        }
        return bg
    }

    var bg=apply_insulin(insulin_curve);

    var x = d3.scaleTime()
        .range([0, width]);

    var y = d3.scaleLinear().domain([0, 400])
        .rangeRound([height, 0]);

    var xAxis = d3.axisBottom(x),
        yAxis = d3.axisLeft(y);

    var line = d3.line()
        .x(function (d) { return x(d[0]); })
        .y(function (d) { return y(d[1]); });

    let drag = d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);

    svg.append('rect')
        .attr('class', 'zoom')
        .attr('cursor', 'move')
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('width', width)
        .attr('height', height)
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

    // shade time in range section
    svg.append('rect')
        .style("fill", "#EFF6FE")
        .attr("x", 50)
        .attr("y", 280)
        .attr("width", 680)
        .attr("height", 130);

    //rough estimate of upper threshold
    svg.append('line')
        .style("stroke", "#FFB800") // color of upper threshold line
        .style("stroke-dasharray", ("3, 5"))
        .style("stroke-width", 2)
        .attr("x1", 50)
        .attr("y1", 280)
        .attr("x2", 720)
        .attr("y2", 280);


    //rough estimate of lower threshold
    svg.append('line')
        .style("stroke", "#EB8690") // color of lower threshold line
        .style("stroke-dasharray", ("3, 5"))
        .style("stroke-width", 2)
        .attr("x1", 50)
        .attr("y1", 410)
        .attr("x2", 720)
        .attr("y2", 410);

    // upper threshold label
    svg.append("text")
        .attr("y", 285)
        .attr("x", 735)
        .attr('text-anchor', 'middle')
        .attr("class", "range") // use to style in stylesheet
        .text("180");

    // lower threshold label
    svg.append("text")
        .attr("y", 415)
        .attr("x", 735)
        .attr('text-anchor', 'middle')
        .attr("class", "range") // use to style in stylesheet
        .text("70");

    svg.append("text")
        .attr("transform", "translate(12,340) rotate(-90)")
        .attr("class", "range") // use to style in stylesheet
        .text("glucose (mg/dL)");

    var focus = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var insulin_g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(bg, function (d) { return d[0]; }));
    y.domain([0, 400]);

    focus.selectAll('circle')
        .data(bg)
        .enter()
        .append('circle')
        .attr('r', 3.0)
        .attr('cx', function (d) { return x(d[0]); })
        .attr('cy', function (d) { return y(d[1]); })
        .style('cursor', 'pointer')
        .style('fill', '#06278E'); // glucose curve color

    focus.selectAll('circle')
        .call(drag);

    focus.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

    focus.append('g')
        .attr('class', 'axis axis--y')
        .call(yAxis);

    function dragstarted(d) {
        d3.select(this).raise().classed('active', true);
    }

    function dragged(d) {
        d[0] = x.invert(d3.event.x);
        d[1] = y.invert(d3.event.y);
        d3.select(this)
            // how would I modify the points around this one?
            .attr('cy', y(d[1]))
    }

    function dragended(d) {
        d3.select(this).classed('active', false);
    }

</script>
</html>
