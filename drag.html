<!DOCTYPE html>
<!-- https://stackoverflow.com/questions/42720488/d3-v4-drag-line-chart-with-x-and-y-axes -->
<!-- Thanks to Mark - https://stackoverflow.com/users/16363/mark -->



<svg width="500" height="350"></svg>

<input type="range" name="bolus_time" id=bolus_time min="-20" max="20" value="0">

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

    var svg = d3.select("svg"),
        margin = { top: 20, right: 20, bottom: 30, left: 50 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;
    
    //t in hours
    function insulin(t){
        //simple approximation 
        if (t<0 || t>240){
            return 0
        }
        return bg=-(Math.pow(t,2)+t*100)/1000
    }
    default_bolus=70;
    function apply_insulin(bg_data, bolus_index){
        //max 4 hours with 12 values per hour 
        for (i = 0; i < bg_data.length-bolus_index; i++){
            bg_data[bolus_index+i][1]-=insulin(i*5); 
        }
       
        return bg_data
    }

    points = [["12:02:52", 104.0], ["12:07:52", 104.0], ["12:12:51", 103.0], ["12:17:52", 103.0], ["12:22:51", 103.0], ["12:27:51", 103.0], ["12:32:51", 101.0], ["12:37:52", 100.0], ["12:42:51", 101.0], ["12:47:52", 101.0], ["12:52:51", 102.0], ["12:57:51", 102.0], ["13:02:50", 102.0], ["13:07:50", 102.0], ["13:12:51", 101.0], ["13:17:51", 100.0], ["13:22:51", 100.0], ["13:27:51", 101.0], ["13:32:51", 100.0], ["13:37:51", 100.0], ["13:42:51", 101.0], ["13:47:50", 101.0], ["13:52:50", 100.0], ["13:57:52", 98.0], ["14:02:51", 100.0], ["14:07:51", 101.0], ["14:12:51", 99.0], ["14:17:51", 91.0], ["14:22:52", 90.0], ["14:27:51", 95.0], ["14:32:52", 94.0], ["14:37:51", 93.0], ["14:42:51", 96.0], ["14:47:51", 95.0], ["14:52:51", 96.0], ["14:57:52", 97.0], ["15:02:51", 97.0], ["15:07:50", 97.0], ["15:12:50", 97.0], ["15:17:50", 94.0], ["15:22:50", 92.0], ["15:27:50", 93.0], ["15:32:51", 94.0], ["15:37:51", 93.0], ["15:42:50", 92.0], ["15:47:50", 91.0], ["15:52:50", 90.0], ["15:57:50", 89.0], ["16:02:50", 90.0], ["16:07:51", 92.0], ["16:12:49", 95.0], ["16:17:50", 98.0], ["16:22:50", 101.0], ["16:27:50", 102.0], ["16:32:49", 106.0], ["16:37:50", 109.0], ["16:42:51", 111.0], ["16:47:51", 114.0], ["16:52:50", 114.0], ["16:57:51", 115.0], ["17:02:50", 118.0], ["17:07:50", 117.0], ["17:12:50", 118.0], ["17:17:50", 128.0], ["17:22:51", 132.0], ["17:27:50", 133.0], ["17:32:50", 133.0], ["17:37:50", 136.0], ["17:42:50", 140.0], ["17:47:50", 141.0], ["17:52:51", 144.0], ["17:57:51", 151.0], ["18:02:50", 156.0], ["18:07:50", 164.0], ["18:12:50", 168.0], ["18:17:51", 173.0], ["18:22:51", 181.0], ["18:27:51", 188.0], ["18:32:51", 198.0], ["18:37:51", 205.0], ["18:42:51", 209.0], ["18:47:50", 212.0], ["18:52:50", 210.0], ["18:57:51", 213.0], ["19:02:50", 216.0], ["19:07:51", 222.0], ["19:12:50", 222.0], ["19:17:51", 224.0], ["19:22:51", 223.0], ["19:27:51", 229.0], ["19:32:51", 230.0], ["19:37:50", 226.0], ["19:42:49", 223.0], ["19:47:50", 229.0], ["19:52:50", 225.0], ["19:57:50", 230.0], ["20:02:49", 235.0], ["20:07:50", 235.0], ["20:12:50", 235.0], ["20:17:49", 238.0], ["20:22:50", 230.0], ["20:27:50", 228.0], ["20:32:49", 237.0], ["20:37:49", 239.0], ["20:42:50", 238.0], ["20:47:50", 235.0], ["20:52:49", 231.0], ["20:57:50", 225.0], ["21:02:50", 226.0], ["21:07:50", 218.0], ["21:12:50", 210.0], ["21:17:50", 218.0], ["21:22:50", 208.0], ["21:27:50", 201.0], ["21:32:50", 198.0], ["21:37:50", 199.0], ["21:42:50", 190.0], ["21:47:50", 187.0], ["21:52:49", 181.0], ["21:57:50", 182.0], ["22:02:50", 180.0], ["22:07:50", 178.0], ["22:12:50", 179.0], ["22:17:49", 177.0], ["22:22:50", 174.0], ["22:27:50", 169.0], ["22:32:50", 166.0], ["22:37:50", 161.0], ["22:42:50", 161.0], ["22:47:50", 158.0], ["22:52:49", 156.0], ["22:57:50", 154.0], ["23:02:50", 151.0], ["23:07:50", 147.0], ["23:12:50", 147.0], ["23:17:50", 146.0], ["23:22:50", 140.0], ["23:27:50", 136.0], ["23:32:50", 135.0], ["23:37:50", 133.0], ["23:42:50", 128.0], ["23:47:50", 124.0], ["23:52:50", 120.0], ["23:57:50", 119.0]]
   
    var timeParse = d3.timeParse("%H:%M:%S")
    points.forEach(d => {
        d[0] = timeParse(d[0])
    })
    bg=Array.from(points);

    var x = d3.scaleTime()
        .range([0, width]);

    var y = d3.scaleLinear().domain([0, 400])
        .rangeRound([height, 0]);

    var xAxis = d3.axisBottom(x),
        yAxis = d3.axisLeft(y);

    var line = d3.line()
        .x(function (d) { return x(d[0]); })
        .y(function (d) { return y(d[1]); });

    let drag = d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);

    svg.append('rect')
        .attr('class', 'zoom')
        .attr('cursor', 'move')
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('width', width)
        .attr('height', height)
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

    var focus = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(points, function (d) { return d[0]; }));
    y.domain(d3.extent(points, function (d) { return d[1]; }));

    focus.selectAll('circle')
        .data(points)
        .enter()
        .append('circle')
        .attr('r', 3.0)
        .attr('cx', function (d) { return x(d[0]); })
        .attr('cy', function (d) { return y(d[1]); })
        .style('cursor', 'pointer')
        .style('fill', 'steelblue');

    // focus.selectAll('circle')
    //     .call(drag);

    focus.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

    focus.append('g')
        .attr('class', 'axis axis--y')
        .call(yAxis);

    function dragstarted(d) {
        d3.select(this).raise().classed('active', true);
    }

    function dragged(d) {
        d[0] = x.invert(d3.event.x);
        d[1] = y.invert(d3.event.y);
        d3.select(this)
            // how would I modify the points around this one?
            .attr('cy', y(d[1]))
        //  focus.select('path').attr('d', line);
    }

    function dragended(d) {
        d3.select(this).classed('active', false);
    }

    function update_bg() {
        focus.selectAll('circle')
            .data(points)
            .transition()
            .duration(500)
            .attr('cx', function (d) { return x(d[0]); })
            .attr('cy', function (d) { return y(d[1]); })
            ;
    }

    d3.select("#bolus_time").on("change", function (d) {
        selectedValue = parseInt(this.value, 10);
        console.log(selectedValue)
        points=apply_insulin(bg, default_bolus+selectedValue)
        //points[2][1] += selectedValue * 10;
        update_bg(); 

    });

</script>