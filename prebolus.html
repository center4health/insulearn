<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Diabetes Educational Tool</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <!-- https://stackoverflow.com/questions/42720488/d3-v4-drag-line-chart-with-x-and-y-axes -->
  <!-- Thanks to Mark - https://stackoverflow.com/users/16363/mark -->
  <body>

    <!--Fixed Navigation Bar-->
    <nav class="navbar navbar-default navbar-fixed-top" id="header">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html"><b>Name of Site</b></a>
        </div>

        <!-- Links to home, interactive graphs, terminology, and about -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="index.html">Home</a></li>
            <li class="active"><a href="#">Interactive Graphs</a></li>
            <li><a href="terminology.html">Terminology</a></li>
            <li><a href="about.html">About</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>

    <div class="container">
      <center>
        <svg width="750" height="525"></svg> <!-- changed the size of the graph -->
        <input type="range" name="bolus_time" id=bolus_time min="-150" max="100" value="0" style="width: 700px"></input>
        <p id="selectedTime">Time of Bolus: 5:00 PM</p>
        <br>
        <input type="range" name="insulin_amt" id=insulin_amt min="0" max="20" value="4" style="width: 700px">Amount of Insulin</input>
      </center>
    </div>

  </body>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    //let's get our data ready

    let bg_raw = [["12:02:52", 104.0], ["12:07:52", 104.0], ["12:12:51", 103.0],
                ["12:17:52", 103.0], ["12:22:51", 103.0], ["12:27:51", 103.0],
                ["12:32:51", 101.0], ["12:37:52", 100.0], ["12:42:51", 101.0],
                ["12:47:52", 101.0], ["12:52:51", 102.0], ["12:57:51", 102.0],
                ["13:02:50", 102.0], ["13:07:50", 102.0], ["13:12:51", 101.0],
                ["13:17:51", 100.0], ["13:22:51", 100.0], ["13:27:51", 101.0],
                ["13:32:51", 100.0], ["13:37:51", 100.0], ["13:42:51", 101.0],
                ["13:47:50", 101.0], ["13:52:50", 100.0], ["13:57:52", 98.0],
                ["14:02:51", 100.0], ["14:07:51", 101.0], ["14:12:51", 99.0],
                ["14:17:51", 91.0], ["14:22:52", 90.0], ["14:27:51", 95.0],
                ["14:32:52", 94.0], ["14:37:51", 93.0], ["14:42:51", 96.0],
                ["14:47:51", 95.0], ["14:52:51", 96.0], ["14:57:52", 97.0],
                ["15:02:51", 97.0], ["15:07:50", 97.0], ["15:12:50", 97.0],
                ["15:17:50", 94.0], ["15:22:50", 92.0], ["15:27:50", 93.0],
                ["15:32:51", 94.0], ["15:37:51", 93.0], ["15:42:50", 92.0],
                ["15:47:50", 91.0], ["15:52:50", 90.0], ["15:57:50", 89.0],
                ["16:02:50", 90.0], ["16:07:51", 92.0], ["16:12:49", 95.0],
                ["16:17:50", 98.0], ["16:22:50", 101.0], ["16:27:50", 102.0],
                ["16:32:49", 106.0], ["16:37:50", 109.0], ["16:42:51", 111.0],
                ["16:47:51", 114.0], ["16:52:50", 114.0], ["16:57:51", 115.0],
                ["17:02:50", 118.0], ["17:07:50", 117.0], ["17:12:50", 118.0],
                ["17:17:50", 128.0], ["17:22:51", 132.0], ["17:27:50", 133.0],
                ["17:32:50", 133.0], ["17:37:50", 136.0], ["17:42:50", 140.0],
                ["17:47:50", 141.0], ["17:52:51", 144.0], ["17:57:51", 151.0],
                ["18:02:50", 156.0], ["18:07:50", 164.0], ["18:12:50", 168.0],
                ["18:17:51", 173.0], ["18:22:51", 181.0], ["18:27:51", 188.0],
                ["18:32:51", 198.0], ["18:37:51", 205.0], ["18:42:51", 209.0],
                ["18:47:50", 212.0], ["18:52:50", 210.0], ["18:57:51", 213.0],
                ["19:02:50", 216.0], ["19:07:51", 222.0], ["19:12:50", 222.0],
                ["19:17:51", 224.0], ["19:22:51", 223.0], ["19:27:51", 229.0],
                ["19:32:51", 230.0], ["19:37:50", 226.0], ["19:42:49", 223.0],
                ["19:47:50", 229.0], ["19:52:50", 225.0], ["19:57:50", 230.0],
                ["20:02:49", 235.0], ["20:07:50", 235.0], ["20:12:50", 235.0],
                ["20:17:49", 238.0], ["20:22:50", 240.0], ["20:27:50", 248.0],
                ["20:32:49", 257.0], ["20:37:49", 259.0], ["20:42:50", 260.0],
                ["20:47:50", 269.0], ["20:52:49", 269.0], ["20:57:50", 269.0],
                ["21:02:50", 267.0], ["21:07:50", 274.0], ["21:12:50", 275.0],
                ["21:17:50", 272.0], ["21:22:50", 273.0], ["21:27:50", 275.0],
                ["21:32:50", 288.0], ["21:37:50", 278.0], ["21:42:50", 280.0],
                ["21:47:50", 284.0], ["21:52:49", 281.0], ["21:57:50", 282.0],
                ["22:02:50", 280.0], ["22:07:50", 278.0], ["22:12:50", 279.0],
                ["22:17:49", 277.0], ["22:22:50", 274.0], ["22:27:50", 279.0],
                ["22:32:50", 276.0], ["22:37:50", 281.0], ["22:42:50", 281.0],
                ["22:47:50", 278.0], ["22:52:49", 276.0], ["22:57:50", 274.0],
                ["23:02:50", 281.0], ["23:07:50", 277.0], ["23:12:50", 277.0],
                ["23:17:50", 276.0], ["23:22:50", 280.0], ["23:27:50", 286.0],
                ["23:32:50", 285.0], ["23:37:50", 283.0], ["23:42:50", 288.0],
                ["23:47:50", 284.0], ["23:52:50", 280.0], ["23:57:50", 289.0]];
    let insulin = [[0, 0], [30, 30], [60, 80], [90, 95], [120, 100], [150, 90], [180, 50], [210, 35], [240, 20], [270, 15], [300, 10], [330, 5], [360, 0]]


    var timeParse = d3.timeParse("%H:%M:%S")
    bg_raw.forEach(d => {
        d[0] = timeParse(d[0]);
    })


    default_bolus_time = timeParse("17:00:00");
    offset = 0;
    var dose = 1;

    function calculate_insulin_curve(bolus = default_bolus_time) {
        var curve = [];
        insulin.forEach(d => {

            curve.push([d3.timeMinute.offset(bolus, d[0]), dose*d[1]])
        })
        return curve
    }
    insulin_curve = calculate_insulin_curve();

    //console.log(insulin_curve)

    var svg = d3.select("svg"),
        margin = { top: 20, right: 20, bottom: 30, left: 50 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;


    function apply_insulin(insulin){
        //ugly way of copying an array
        var bg = bg_raw.map(function(arr) {
                return arr.slice();
            });

        k=0
        for (i = 0; i < bg.length; i++){

            if (bg[i][0]>insulin[0][0]){
                var old_change=bg_raw[i][1]-bg_raw[i-1][1];

                bg[i][1]=bg[i-1][1]+old_change

                if (Math.floor(k/6)<insulin.length){
                    bg[i][1]-=insulin[Math.floor(k/6)][1]/20;
                }
                k+=1
            }
        }
        return bg
    }

    var bg=apply_insulin(insulin_curve);

    var x = d3.scaleTime()
        .range([0, width]);

    var y = d3.scaleLinear().domain([0, 400])
        .rangeRound([height, 0]);

    var xAxis = d3.axisBottom(x),
        yAxis = d3.axisLeft(y);

    // var low_threshold = d3.line()
    //     .x(function(d) { return x(d[0]); })
    //     .y(return y(70); );

    var line = d3.line()
        .x(function (d) { return x(d[0]); })
        .y(function (d) { return y(d[1]); });

    let drag = d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);

    svg.append('rect')
        .attr('class', 'zoom')
        .attr('cursor', 'move')
        .attr('fill', 'none')
        .attr('pointer-events', 'all')
        .attr('width', width)
        .attr('height', height)
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

    //rough estimate of upper threshold
    svg.append('line')
        .style("stroke", "#FFB800") // color of upper threshold line
        .style("stroke-dasharray", ("3, 5"))
        .style("stroke-width", 2)
        .attr("x1", 50)
        .attr("y1", 280)
        .attr("x2", 720)
        .attr("y2", 280);


    //rough estimate of lower threshold
    svg.append('line')
        .style("stroke", "#EB8690") // color of lower threshold line
        .style("stroke-dasharray", ("3, 5"))
        .style("stroke-width", 2)
        .attr("x1", 50)
        .attr("y1", 410)
        .attr("x2", 720)
        .attr("y2", 410);

    // upper threshold label
    svg.append("text")
       .attr("y", 285)
       .attr("x", 735)
       .attr('text-anchor', 'middle')
       .attr("class", "range") // use to style in stylesheet
       .text("180");

    // lower threshold label
    svg.append("text")
        .attr("y", 415)
        .attr("x", 735)
        .attr('text-anchor', 'middle')
        .attr("class", "range") // use to style in stylesheet
        .text("70");

    svg.append("text")
        .attr("transform", "translate(12,340) rotate(-90)")
        .attr("class", "range") // use to style in stylesheet
        .text("glucose (mg/dL)");



    var focus = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var insulin_g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(bg, function (d) { return d[0]; }));
    y.domain([0, 400]);

    // svg.append("path")      // Add the low threshold line.
    //     .attr("class", "line")
    //     .attr("d", low_threshold(data));

    insulin_g.append("path")
      .datum(insulin_curve)
      .attr("fill", "none")
      .attr("stroke", "#41948E") // insulin curve color
      .attr("stroke-width", 5) // size(stroke) of the insulin curve
      .attr("d", d3.line()
        .x(function(d) { return x(d[0]) })
        .y(function(d) { return y(d[1]) })
        )

    focus.selectAll('circle')
        .data(bg)
        .enter()
        .append('circle')
        .attr('r', 3.0)
        .attr('cx', function (d) { return x(d[0]); })
        .attr('cy', function (d) { return y(d[1]); })
        .style('cursor', 'pointer')
        .style('fill', '#06278E'); // glucose curve color

    focus.selectAll('circle')
        .call(drag);

    focus.append('g')
        .attr('class', 'axis axis--x')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

    focus.append('g')
        .attr('class', 'axis axis--y')
        .call(yAxis);

    function dragstarted(d) {
        d3.select(this).raise().classed('active', true);
    }

    function dragged(d) {
        d[0] = x.invert(d3.event.x);
        d[1] = y.invert(d3.event.y);
        d3.select(this)
            // how would I modify the points around this one?
            .attr('cy', y(d[1]))
        //  focus.select('path').attr('d', line);
    }

    function dragended(d) {
        d3.select(this).classed('active', false);
    }

    function update_bg(data) {
        focus.selectAll('circle')
            .data(data)
            // .transition()
            // .duration(500)
            .attr('cx', function (d) { return x(d[0]); })
            .attr('cy', function (d) { return y(d[1]); })
            ;
    }

    function update_insulin(data) {
        insulin_g.selectAll("path")
            .datum(data)
            // .transition()
            // .duration(500)
            .attr("d", d3.line()
                .x(function (d) { return x(d[0]) })
                .y(function (d) { return y(d[1]) })
            )
    }

    var b_t = default_bolus_time;

    d3.select("#bolus_time").on("input", function (d) {
        selectedValue = parseInt(this.value, 10);

        var bolus_time=d3.timeMinute.offset(default_bolus_time, selectedValue);


        // Updating the selected time
        var hours = bolus_time.getHours(); // gives the value in 24 hours format
        var AmOrPm = hours >= 12 ? 'PM' : 'AM';
        hours = (hours % 12) || 12;
        var minutes = bolus_time.getMinutes() > 9 ? bolus_time.getMinutes() : '0' + bolus_time.getMinutes();
        var finalTime = "Time of Bolus: " + hours + ":" + minutes + " " + AmOrPm;
        document.getElementById("selectedTime").innerHTML = finalTime;


        b_t = bolus_time;
        var insulin = calculate_insulin_curve(bolus_time);
        update_insulin(insulin);
        var bg_data=apply_insulin(insulin);
        update_bg(bg_data);
    });

    d3.select("#insulin_amt").on("input", function (d) {
        dose = parseInt(this.value, 10)/4
        var insulin = calculate_insulin_curve(b_t);
        update_insulin(insulin);
        var bg_data=apply_insulin(insulin)
        update_bg(bg_data);
    });




</script>
</html>
